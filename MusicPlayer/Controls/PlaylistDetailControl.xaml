<UserControl x:Class="MusicPlayer.Controls.PlaylistDetailControl"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:local="clr-namespace:MusicPlayer.Controls"
              xmlns:ui="http://schemas.lepo.co/wpfui/2022/xaml"
 xmlns:Helper="clr-namespace:MusicPlayer.Helper"
             xmlns:converters="clr-namespace:MusicPlayer.Converters"
             mc:Ignorable="d" 
             d:DesignHeight="450" d:DesignWidth="800">
    <UserControl.Resources>
        <converters:NotNullToBooleanConverter x:Key="NotNullToBooleanConverter"/>
        <!-- 搜索框宽度转换器 -->
        <converters:SearchBoxWidthConverter x:Key="SearchBoxWidthConverter"/>
    </UserControl.Resources>
    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="auto"/>
            <RowDefinition Height="auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <!-- 歌单信息区域 -->
        <StackPanel Grid.Row="0"  HorizontalAlignment="Center">
            <TextBlock x:Name="PlaylistName"  Text="{Binding CurrentPlaylist.Name}" FontSize="24" FontWeight="Bold" HorizontalAlignment="Center" />
            <TextBlock x:Name="PlaylistDescription" Text="{Binding CurrentPlaylist.Description}" FontSize="14" Opacity="0.7" HorizontalAlignment="Center"  />
        </StackPanel>
        
        <StackPanel Grid.Row="1"   Orientation="Horizontal"
                    VerticalAlignment="Center" HorizontalAlignment="Left">

            <ui:Button ToolTip="播放全部" Command="{Binding PlayAllCommand}"
 HorizontalAlignment="Center"
 Width="auto" 
Padding="5" Margin="5">
                <StackPanel Orientation="Horizontal">
                    <Helper:CustomIcon HorizontalAlignment="Left" Margin="5,2" Kind="Play" />
                    <Separator Margin="2" />
                    <ui:TextBlock Text="播放全部"/>
                </StackPanel>
            </ui:Button>

            <ui:Button ToolTip="随机播放" Command="{Binding ShufflePlayCommand}"
 HorizontalAlignment="Center"
 Width="auto" 
Padding="5" Margin="5">
                <StackPanel Orientation="Horizontal">
                    <Helper:CustomIcon HorizontalAlignment="Left" Margin="5,2" Kind="Shuffle" />
                    <Separator Margin="2" />
                    <ui:TextBlock Text="随机播放"/>
                </StackPanel>
            </ui:Button>
        </StackPanel>
        
        
        
        <!-- 操作区域 -->
        <StackPanel Grid.Row="1"  Orientation="Horizontal" HorizontalAlignment="Right">
            
 
            <!-- 搜索区域 -->
            <ui:Button   Width="auto" ToolTip="搜索" Margin="0,0,5,0" Background="Transparent" BorderThickness="0" Command="{Binding SearchButtonClickCommand}">
                <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                    <Helper:CustomIcon Kind="Search" />
                    <Separator Margin="2" />
                    <TextBox x:Name="SearchTextBox" Width="{Binding IsSearchExpanded, Converter={StaticResource SearchBoxWidthConverter}}"
                          FontSize="14" FontWeight="Normal"  Text="{Binding SearchText, UpdateSourceTrigger=PropertyChanged}"   
                          HorizontalAlignment="Left" VerticalAlignment="Center"   
                          MaxLength="20"
                          Background="Transparent" BorderThickness="0">
                        <TextBox.Resources>
                            <Style TargetType="TextBox">
                                <Style.Triggers>
                                    <Trigger Property="IsFocused" Value="False">
                                        <Setter Property="Background" Value="Transparent"/>
                                        <Setter Property="Text" Value="{Binding SearchText, TargetNullValue='搜索歌曲...'}"/>
                                    </Trigger>
                                </Style.Triggers>
                            </Style>
                        </TextBox.Resources>
                    </TextBox>
                </StackPanel>
            </ui:Button>

            <StackPanel      Orientation="Horizontal" MinWidth="80" VerticalAlignment="Center" HorizontalAlignment="Right">
                <ui:TextBlock Text="共" FontSize="14" VerticalAlignment="Center"  Opacity="0.7"/>
                <ui:TextBlock Text="{Binding SongCount}" FontSize="14" VerticalAlignment="Center"  Margin="2,0"/>
                <ui:TextBlock Text="首" FontSize="14" VerticalAlignment="Center" Opacity="0.7"/>
            </StackPanel> 
        </StackPanel>

        <!-- 歌曲列表区域 -->
        <Border Grid.Row="2" CornerRadius="0,8,8,0" Background="Transparent"  
                HorizontalAlignment="Stretch" >
            <Border.Effect>
                <DropShadowEffect BlurRadius="8" ShadowDepth="2" Color="Black" Opacity="0.1"/>
            </Border.Effect>

            <Grid >
                <!-- 歌曲列表 -->
                <ui:ListView x:Name="PlaylistListBox" Grid.Row="1"    ItemsSource="{Binding FilteredPlaylist}" SelectedItem="{Binding CurrentPlaylistItem, Mode=TwoWay}" 
                           Background="Transparent" BorderThickness="0" AlternationCount="2"  
                           ScrollViewer.HorizontalScrollBarVisibility="Disabled"
                            ScrollViewer.VerticalScrollBarVisibility="Auto"
                            ScrollViewer.CanContentScroll="True"
                            VirtualizingStackPanel.IsVirtualizing="True"
                            VirtualizingStackPanel.VirtualizationMode="Recycling"
                            VirtualizingStackPanel.ScrollUnit="Pixel"
                            VirtualizingStackPanel.CacheLength="1"
                            VirtualizingStackPanel.CacheLengthUnit="Item"
                            Helper:PlaylistScrollBehavior.IsEnabled="True" 
                            SelectionMode="Single"
                            Helper:NewPlaylistAlbumArtBehavior.IsEnabled="True"
                            Helper:NewPlaylistAlbumArtBehavior.ViewModel="{Binding}"
                              Helper:PlaylistInteractionBehavior.IsEnabled="True"
                            Helper:PlaylistScrollToCurrentSongBehavior.IsEnabled="True">

                    <ui:ListView.ItemContainerStyle>
                        <Style TargetType="ListBoxItem">
                            <!-- 优化虚拟化性能的设置 -->
                            <Setter Property="Padding" Value="5,10"/>
                            <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
                            <Setter Property="VerticalContentAlignment" Value="Stretch"/>
                            <Setter Property="FocusVisualStyle" Value="{x:Null}"/>

                            <Setter Property="Template">
                                <Setter.Value>
                                    <ControlTemplate TargetType="ListBoxItem">
                                        <Border x:Name="ItemBorder" CornerRadius="8" Margin="0,0,15,0" Background="{TemplateBinding Background}" Padding="{TemplateBinding Padding}">
                                            <ContentPresenter/>
                                        </Border>
                                    </ControlTemplate>
                                </Setter.Value>
                            </Setter>

                            <Style.Triggers>
                                <Trigger Property="IsSelected" Value="True">
                                    <Setter Property="Background" Value="#80FFFFFF"/>
                                </Trigger>
                                <Trigger Property="IsSelected" Value="False">
                                    <Setter Property="Background" Value="Transparent"/>
                                </Trigger>
                                <Trigger Property="IsMouseOver" Value="True">
                                    <Setter Property="Background" Value="#4DFFFFFF" />
                                </Trigger>
                            </Style.Triggers>
                        </Style>
                    </ui:ListView.ItemContainerStyle>
                    <ui:ListView.ItemTemplate>
                        <DataTemplate >
                            <Grid Margin="0,5">
                                <Grid.ColumnDefinitions>

                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="auto"/>
                                </Grid.ColumnDefinitions>

                                <!-- 专辑封面缩略图 -->
                                <Border Grid.Column="0"  Width="40" Height="40" CornerRadius="8" Background="#1AFFFFFF" Margin="0,0,8,0">
                                    <Border.Style>
                                        <Style TargetType="Border">
                                            <Style.Triggers>
                                                <!-- 当专辑封面为空时显示默认图标 -->
                                                <DataTrigger Binding="{Binding AlbumArt}" Value="{x:Null}">
                                                    <Setter Property="Background" Value="#33FFFFFF"/>
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </Border.Style>

                                    <Grid>

                                        <Helper:CustomIcon Kind="MusicNote"   IconSize="20"  
                                            HorizontalAlignment="Center" VerticalAlignment="Center"
                                            Visibility="{Binding AlbumArt, Converter={StaticResource NotNullToBooleanConverter}, ConverterParameter=Invert}"/>

                                        <!-- 实际专辑封面 -->
                                        <Image Source="{Binding AlbumArt}" Stretch="Fill" 
                                 Visibility="{Binding AlbumArt, Converter={StaticResource NotNullToBooleanConverter}}">
                                            <Image.Clip>
                                                <RectangleGeometry   RadiusX="8"   RadiusY="8" Rect="0,0,39,39" />
                                            </Image.Clip>
                                        </Image>
                                    </Grid>
                                </Border>

                                <!-- 歌曲信息 -->
                                <StackPanel Grid.Column="1" VerticalAlignment="Center">
                                    <TextBlock Text="{Binding Title}" FontWeight="SemiBold" FontSize="14" Margin="0,0,0,2"/>
                                    <TextBlock Text="{Binding Artist}" FontSize="12"     Opacity="0.7"   />
                                </StackPanel>
                                <StackPanel Grid.Column="2" Orientation="Horizontal"  VerticalAlignment="Center">
                                    <Separator Margin="5,0" />
                                    <TextBlock Text="{Binding Album}" FontSize="12" Width="300" TextWrapping="Wrap"   />
                                </StackPanel>

                                <!--歌曲时长，音质图标-->
                                <StackPanel Grid.Column="3" VerticalAlignment="Center" Margin="0,0,25,0">
                                    <ui:TextBlock Text="{Binding TotalTimeText}"   FontSize="12"  VerticalAlignment="Center"  />
                                    <Helper:ButtonControl AudioFormat="{Binding AudioFormat}"></Helper:ButtonControl>
                                </StackPanel>
                            </Grid>
                        </DataTemplate>
                    </ui:ListView.ItemTemplate>
                </ui:ListView>
            </Grid>
        </Border>
    </Grid>
</UserControl>
